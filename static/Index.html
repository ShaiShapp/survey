<!DOCTYPE html>
<html>
<head>
  <title>Shai's Surveys</title>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="/static/SurveyComponents.js"></script>
  <link rel="stylesheet" href="/static/Survey.css"></script>
  <!--link rel="icon" type="image/png" href="http://example.com/myicon.png"-->
</head>
<body>
  <h3 id="ErrorMessage" style="display: none"></h3>
  <div id="SurveyDiv" v-bind:title="title">
    <h1 v-if="title">{{ title }}</h1>
    <div id="AllQuestionsDiv" v-if="displayMode === 'survey' && !pagedMode">
        <button v-on:click="togglePagedMode();" class="button-general">View one question per page</button>
        <survey-question v-for="question, index in questions"
                         v-bind:title="question.title"
                         v-bind:idx="index"
                         v-bind:def="answers[index] || question.default || ''"
                         v-bind:key="index"
                         v-bind:type="question.type || 'text'"
                         v-bind:options="question.options"
                         v-bind:required="question.required"
                         v-on:input="save"></survey-question>
        <button v-on:click="showSummary();" class="button-general">Done</button>
        <p v-if="validationError">{{ validationError }}</p>
    </div>
    
    <div id="SummaryDiv" v-if="displayMode === 'summary'">
        <h3>Your answers:</h3>
        <survey-answer-summary v-for="question, index in questions"
                         v-bind:title="question.title"
                         v-bind:idx="index"
                         v-bind:answer="answers[index] || question.default || ''"
                         v-bind:key="index"
                         v-bind:type="question.type || 'text'"></survey-answer-summary>
        <button v-if="!submissionDate" v-on:click="showSurvey();" class="button-general">Return</button>
        <button v-if="!submissionDate" v-on:click="submitAnswers();" class="button-general">Submit</button>
    </div>
    
    <div id="SingleQuestionDiv" v-if="displayMode === 'survey' && pagedMode">
        <button v-on:click="togglePagedMode();" class="button-general">View all questions in one page</button>
        <survey-question v-bind:title="questions[currentQuestionIndex].title"
                         v-bind:idx="currentQuestionIndex"
                         v-bind:def="answers[currentQuestionIndex] || questions[currentQuestionIndex].default || ''"
                         v-bind:key="currentQuestionIndex"
                         v-bind:type="questions[currentQuestionIndex].type || 'text'"
                         v-bind:options="questions[currentQuestionIndex].options"
                         v-bind:required="questions[currentQuestionIndex].required"
                         v-on:input="save"></survey-question>
        <button v-if="!isFirstQuestion()" v-on:click="previousQuestion();" class="button-general">Previous</button>
        <button v-if="!isLastQuestion()" v-on:click="nextQuestion();" class="button-general">Next</button>
        <button v-if="isLastQuestion()" v-on:click="showSummary();" class="button-general">Done</button>
        <p v-if="validationError">{{ validationError }}</p>
    </div>
  </div>

  <script>    
    loadSurveyData();
    
    function saveAnswer(answer, index)
    {
        let urlParams = new URLSearchParams(window.location.search);
        let surveyLink = urlParams.get('SurveyLink');
        this.answers[index] = answer;
        
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && !this.status == 200) {
                console.log(this.responseText);
            }
          };
        xhttp.open("POST", "/SaveAnswer", true);
        xhttp.send("surveylink=" + surveyLink + "&answerid=" + index + "&answertext=" + answer);
    }
    
    function validateSurvey(surveyDescriptor)
    {
        let unansweredQuestions = [];
        for (let i = 0; i < surveyDescriptor.questions.length; i++)
        {
            if (!surveyDescriptor.answers[i] && surveyDescriptor.questions[i].required) unansweredQuestions.push(surveyDescriptor.questions[i].title);
        }
        if (unansweredQuestions.length > 0)
        {
            surveyDescriptor.validationError = "Please provide valid answers to the following questions: " + unansweredQuestions.join(", ");
            return false;
        } else
        {
            surveyDescriptor.validationError = "";
            return true;
        }
    }

    function submitAnswers()
    {
        let urlParams = new URLSearchParams(window.location.search);
        let surveyLink = urlParams.get('SurveyLink');
        
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && !this.status == 200) {
                console.log(this.responseText);
            }
          };
        xhttp.open("POST", "/SubmitAnswers", true);
        xhttp.send("surveylink=" + surveyLink);
    }
    
    function loadSurveyData()
    {
        let urlParams = new URLSearchParams(window.location.search);
        let surveyLink = urlParams.get('SurveyLink');
        if (!surveyLink) return;
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                let surveyData = JSON.parse(this.responseText);
                if (surveyData.hasOwnProperty("error"))
                {
                    document.getElementById("SurveyDiv").style.display = "none";
                    document.getElementById("ErrorMessage").style.display = "block";
                    document.getElementById("ErrorMessage").innerText = "Error: " + surveyData.error;
                } else
                {
                    let surveyDescriptor = JSON.parse(surveyData.descriptor);
                    let surveyAnswers = surveyData.answers;
                    initializeSurveyAnswers(surveyDescriptor, surveyAnswers);
                    surveyDescriptor.currentQuestionIndex = 0;
                    surveyDescriptor.currentQuestion = surveyDescriptor.questions[0];
                    surveyDescriptor.displayMode = surveyData.submissionDate ? 'summary' : 'survey';
                    surveyDescriptor.validationError = '';
                    surveyDescriptor.submissionDate = surveyData.submissionDate;
                    surveyDescriptor.pagedMode = false;
                    let vm = new Vue({
                        el: '#SurveyDiv',
                        data: surveyDescriptor,
                        methods: {submitAnswers: submitAnswers,
                                  save: saveAnswer,
                                  validateSurvey: validateSurvey,
                                  togglePagedMode: function() {this.pagedMode = !this.pagedMode;},
                                  showSummary: function() {if (this.validateSurvey(surveyDescriptor)) this.displayMode = 'summary';},
                                  showSurvey: function() {this.displayMode = 'survey'},
                                  nextQuestion: function() {this.currentQuestionIndex++;},
                                  previousQuestion: function() {this.currentQuestionIndex--;},
                                  isLastQuestion: function() {return this.currentQuestionIndex === this.questions.length - 1;},
                                  isFirstQuestion: function() {return this.currentQuestionIndex === 0;}}
                    });
                }
            }
          };
        xhttp.open("GET", "/GetSurveyData?surveylink=" + surveyLink, true);
        xhttp.send();
    }
    
    function initializeSurveyAnswers(surveyDescriptor, surveyAnswers)
    {
        surveyDescriptor.answers = {};
        if (surveyAnswers && Array.isArray(surveyAnswers))
        {
            surveyAnswers.forEach(function (answer) {surveyDescriptor.answers[answer[0]] = answer[1];});
        }
    }
    
  </script>
</body>
</html>